<!DOCTYPE html>











<html lang="zh-Hans">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>JS 实现深拷贝 - 金成的博客</title>

  
  
  <meta name="description" content="JSON 序列化和反序列化 对于一般（狭义）的对象，最简单快速的方法就是使用 JSON 的序列化和反序列化：
const o1 = { name: &#39;xxx&#39;, age: 18, child: { name: &#39;zzz&#39; } } const o2 = JSON.parse(JSON.stringify(o1)) o1 === o2 // false o1.name === o2.name // true o1.child === o2.child // false o1.child.name === o2.child.name // true 缺点：仅支持 JSON 所支持的数据类型和结构。
例如：
 不支持函数，会被直接忽略 不支持 undefined，会被直接忽略 不支持循环引用，例如 xxx.self = xxx，会报错  对于更复杂的对象，就无法使用上面的办法，需要使用递归来进行深拷贝。
搭建测试环境 安装 mocha、chai 和 sinon-chai：
yarn init -yyarn add mocha chai sinon-chai --devpackage." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://jinchengjoker.github.io/app.min.css" />

  
  <link rel="preload stylesheet" as="style" href="https://jinchengjoker.github.io/an-old-hope.min.css" />
  <script
    defer
    src="https://jinchengjoker.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  <link rel="preload" as="image" href="https://jinchengjoker.github.io/theme.png" />

  

  
  <link rel="icon" href="https://jinchengjoker.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://jinchengjoker.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.92.2" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="JS 实现深拷贝" />
<meta property="og:description" content="JSON 序列化和反序列化 对于一般（狭义）的对象，最简单快速的方法就是使用 JSON 的序列化和反序列化：
const o1 = { name: &#39;xxx&#39;, age: 18, child: { name: &#39;zzz&#39; } } const o2 = JSON.parse(JSON.stringify(o1)) o1 === o2 // false o1.name === o2.name // true o1.child === o2.child // false o1.child.name === o2.child.name // true 缺点：仅支持 JSON 所支持的数据类型和结构。
例如：
 不支持函数，会被直接忽略 不支持 undefined，会被直接忽略 不支持循环引用，例如 xxx.self = xxx，会报错  对于更复杂的对象，就无法使用上面的办法，需要使用递归来进行深拷贝。
搭建测试环境 安装 mocha、chai 和 sinon-chai：
yarn init -yyarn add mocha chai sinon-chai --devpackage." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jinchengjoker.github.io/posts/js/deep_clone/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-20T00:00:00+08:00" />
<meta property="article:modified_time" content="2019-09-20T00:00:00+08:00" />


  
  <meta itemprop="name" content="JS 实现深拷贝">
<meta itemprop="description" content="JSON 序列化和反序列化 对于一般（狭义）的对象，最简单快速的方法就是使用 JSON 的序列化和反序列化：
const o1 = { name: &#39;xxx&#39;, age: 18, child: { name: &#39;zzz&#39; } } const o2 = JSON.parse(JSON.stringify(o1)) o1 === o2 // false o1.name === o2.name // true o1.child === o2.child // false o1.child.name === o2.child.name // true 缺点：仅支持 JSON 所支持的数据类型和结构。
例如：
 不支持函数，会被直接忽略 不支持 undefined，会被直接忽略 不支持循环引用，例如 xxx.self = xxx，会报错  对于更复杂的对象，就无法使用上面的办法，需要使用递归来进行深拷贝。
搭建测试环境 安装 mocha、chai 和 sinon-chai：
yarn init -yyarn add mocha chai sinon-chai --devpackage."><meta itemprop="datePublished" content="2019-09-20T00:00:00+08:00" />
<meta itemprop="dateModified" content="2019-09-20T00:00:00+08:00" />
<meta itemprop="wordCount" content="951">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JS 实现深拷贝"/>
<meta name="twitter:description" content="JSON 序列化和反序列化 对于一般（狭义）的对象，最简单快速的方法就是使用 JSON 的序列化和反序列化：
const o1 = { name: &#39;xxx&#39;, age: 18, child: { name: &#39;zzz&#39; } } const o2 = JSON.parse(JSON.stringify(o1)) o1 === o2 // false o1.name === o2.name // true o1.child === o2.child // false o1.child.name === o2.child.name // true 缺点：仅支持 JSON 所支持的数据类型和结构。
例如：
 不支持函数，会被直接忽略 不支持 undefined，会被直接忽略 不支持循环引用，例如 xxx.self = xxx，会报错  对于更复杂的对象，就无法使用上面的办法，需要使用递归来进行深拷贝。
搭建测试环境 安装 mocha、chai 和 sinon-chai：
yarn init -yyarn add mocha chai sinon-chai --devpackage."/>

  
  
</head>


  <body class="not-ready" data-menu="false">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://jinchengjoker.github.io/">金成的博客</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  

  
</header>


    <main class="main">

<article class="post-single">
  <header class="post-title">
    <p>
      
      <time>Sep 20, 2019</time>
      
      
    </p>
    <h1>JS 实现深拷贝</h1>
  </header>
  <section class="post-content"><h2 id="json-序列化和反序列化">JSON 序列化和反序列化</h2>
<p>对于一般（狭义）的对象，最简单快速的方法就是使用 JSON 的序列化和反序列化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o1</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xxx&#39;</span>,
  <span style="color:#a6e22e">age</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">18</span>,
  <span style="color:#a6e22e">child</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;zzz&#39;</span>
  }
}
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">o1</span>))

<span style="color:#a6e22e">o1</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>  <span style="color:#75715e">// false
</span><span style="color:#75715e"></span><span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">name</span>  <span style="color:#75715e">// true
</span><span style="color:#75715e"></span><span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>  <span style="color:#75715e">// false
</span><span style="color:#75715e"></span><span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span>  <span style="color:#75715e">// true
</span></code></pre></div><p>缺点：仅支持 JSON 所支持的数据类型和结构。</p>
<p>例如：</p>
<ol>
<li>不支持函数，会被直接忽略</li>
<li>不支持 undefined，会被直接忽略</li>
<li>不支持循环引用，例如 xxx.self = xxx，会报错</li>
</ol>
<p><strong>对于更复杂的对象，就无法使用上面的办法，需要使用递归来进行深拷贝。</strong></p>
<h2 id="搭建测试环境">搭建测试环境</h2>
<p>安装 mocha、chai 和 sinon-chai：</p>
<pre tabindex="0"><code>yarn init -y
yarn add mocha chai sinon-chai --dev
</code></pre><p>package.json 添加运行测试命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;scripts&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;test&#34;</span>: <span style="color:#e6db74">&#34;mocha test/**/*.js&#34;</span>
}
</code></pre></div><p>导出 deepClone：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">//  src/index.js
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>() {}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>
</code></pre></div><p>编写测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">//  test/index.js
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">chai</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;chai&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sinonChai</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;sinon-chai&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">deepClone</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../src/index&#39;</span>)

<span style="color:#a6e22e">chai</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">sinonChai</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">assert</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chai</span>.<span style="color:#a6e22e">assert</span>

<span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;测试深拷贝&#39;</span>, () =&gt; {
  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;成功引入深拷贝&#39;</span>, () =&gt; {
    <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">isFunction</span>(<span style="color:#a6e22e">deepClone</span>)
  })
})
</code></pre></div><p>运行测试：</p>
<pre tabindex="0"><code>yarn test
</code></pre><h2 id="递归深拷贝">递归深拷贝</h2>
<h3 id="拷贝基本类型">拷贝基本类型</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝基本类型&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">s1</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;xxx&#39;</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">n1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">u1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">b1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">empty1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">s2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">s1</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">n2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">n1</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">u2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">u1</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">b2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">b1</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">empty2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">empty1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">s2</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">s1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">n2</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">n1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">u2</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">u1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">b2</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">b1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">empty2</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">empty1</span>)
})
</code></pre></div><p>因为基本类型不会存在深浅拷贝的问题，所以直接返回它的值就可以了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>
}
</code></pre></div><h3 id="拷贝一般狭义对象">拷贝一般（狭义）对象</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝一般（狭义）对象&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o1</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xxx&#39;</span>, <span style="color:#a6e22e">child</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;zzz&#39;</span> } }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">o1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">name</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span>)
})
</code></pre></div><p>使用递归来进行深拷贝：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Object) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object()
    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
      <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>
}
</code></pre></div><h3 id="拷贝数组">拷贝数组</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝数组&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a1</span> <span style="color:#f92672">=</span> [[<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">23</span>], [<span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">45</span>], [<span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">67</span>]]
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">a1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">a1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">a2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">a1</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!==</span> <span style="color:#a6e22e">a2</span>[<span style="color:#ae81ff">0</span>])
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">a1</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!==</span> <span style="color:#a6e22e">a2</span>[<span style="color:#ae81ff">1</span>])
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">a1</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">!==</span> <span style="color:#a6e22e">a2</span>[<span style="color:#ae81ff">2</span>])
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">deepEqual</span>(<span style="color:#a6e22e">a1</span>, <span style="color:#a6e22e">a2</span>)
})
</code></pre></div><p>还是使用递归来进行深拷贝，不过在最初生成的时候需要 new Array()，而不是 new Object()。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Object) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Array) {
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array()
      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
        <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
      }
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object()
      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
        <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
      }
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
    }
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>
}
</code></pre></div><h3 id="拷贝函数">拷贝函数</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝函数&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">f1</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">b</span>
  }
  <span style="color:#a6e22e">f1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">yyy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">zzz</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;aaa&#39;</span> } }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">f2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">f1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">f1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">f2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">f1</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>) <span style="color:#f92672">===</span> <span style="color:#a6e22e">f2</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>))
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">f1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">f2</span>.<span style="color:#a6e22e">xxx</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">f1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">f2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">f1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">f2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span>)
})
</code></pre></div><p>通过直接调用源函数的方法，来达到类似深拷贝的目的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...

<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Function) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>)
  }
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
    <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}

...
</code></pre></div><h3 id="拷贝正则表达式">拷贝正则表达式</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝正则表达式&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reg1</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/hi\d+/gi</span>
  <span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">yyy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">zzz</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;aaa&#39;</span> } }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reg2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">reg1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">reg2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">source</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">reg2</span>.<span style="color:#a6e22e">source</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">flags</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">reg2</span>.<span style="color:#a6e22e">flags</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">reg2</span>.<span style="color:#a6e22e">xxx</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">reg2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">reg1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">reg2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span>)
})
</code></pre></div><p>正则表达式有两个非常重要的属性：</p>
<ul>
<li>source 返回主体内容</li>
<li>flags 返回标记</li>
</ul>
<p>可以根据这两个属性，new RegExp() 一个新的正则表达式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...

<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> RegExp) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegExp(<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">flags</span>)
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
    <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}

...
</code></pre></div><h3 id="拷贝日期">拷贝日期</h3>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;拷贝日期&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date()
  <span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">yyy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">zzz</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;aaa&#39;</span> } }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">d1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">d1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">d2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">===</span> <span style="color:#a6e22e">d2</span>.<span style="color:#a6e22e">getTime</span>())
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">d2</span>.<span style="color:#a6e22e">xxx</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">d2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">d1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">d2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span>)
})
</code></pre></div><p>可以使用 new Date() 和源日期对象来初始化一个新的日期对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">...

<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Date) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(<span style="color:#a6e22e">resource</span>)
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
    <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}

...
</code></pre></div><h2 id="跳过原型属性">跳过原型属性</h2>
<p>使用 for &hellip; in 来遍历对象的 key 的时候，会默认遍历原型上的属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">create</span>({ <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xxx&#39;</span> })  <span style="color:#75715e">// name 会在 obj 的 __proto__ 中
</span><span style="color:#75715e"></span><span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">age</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>
<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">obj</span>) {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">key</span>)
}

<span style="color:#75715e">// &#39;age&#39;
</span><span style="color:#75715e">// &#39;name&#39;
</span></code></pre></div><p>一般来说，不拷贝原型上的属性。</p>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;跳过原型属性&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o1</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">create</span>({ <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xxx&#39;</span> })
  <span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">yyy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">zzz</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;aaa&#39;</span> } }
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">o1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>)
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">isTrue</span>(<span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">o1</span>)
  <span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">isFalse</span>(<span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">o2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">xxx</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">xxx</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">xxx</span>.<span style="color:#a6e22e">yyy</span>.<span style="color:#a6e22e">zzz</span>)
})
</code></pre></div><p>所以在递归的时候，需要判断 key 是不是它自身的属性。</p>
<pre tabindex="0"><code>for (let key in resource) {
  if(resource.hasOwnProperty(key)) {
    result[key] = deepClone(resource[key])
  }
}
</code></pre><h2 id="代码优化">代码优化</h2>
<p>整合上面的代码，进行优化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">//  src/index.js
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Object) {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Array) {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array()
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Function) {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>)
      }
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> RegExp) {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegExp(<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">flags</span>)
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Date) {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(<span style="color:#a6e22e">resource</span>)
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object()
    }
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">key</span>)) {
        <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
      }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>
}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>
</code></pre></div><p>可以直观的看出，对于不同的复杂对象，只需要对其进行不同的特殊处理即可。</p>
<h2 id="环处理">环处理</h2>
<p>递归拷贝还有一个问题，就是对于环的处理。</p>
<p>例如 window.self 就是一个环，它指向 window 自己。当递归拷贝遇到环，就会陷入无限的循环。</p>
<p>编写测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;环拷贝&#39;</span>, () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o1</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xxx&#39;</span>, <span style="color:#a6e22e">child</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;zzz&#39;</span> } }
  <span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">self</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">o1</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">o1</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">name</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">name</span>)
  <span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">o1</span>.<span style="color:#a6e22e">self</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">o2</span>.<span style="color:#a6e22e">self</span>)
})
</code></pre></div><p>处理的思路：对已处理过的对象进行缓存，在递归的同时，检查是否有缓存，如果发现有缓存，则代表有环，就直接返回该对象，达到环拷贝的目的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">//  src/index.js
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cacheStack</span> <span style="color:#f92672">=</span> []

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Object) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cache</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">findCache</span>(<span style="color:#a6e22e">resource</span>)
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cache</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cache</span>
    } <span style="color:#66d9ef">else</span> {
      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Array) {
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array()
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Function) {
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>)
        }
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> RegExp) {
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegExp(<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">flags</span>)
      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">instanceof</span> Date) {
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(<span style="color:#a6e22e">resource</span>)
      } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object()
      }
      <span style="color:#a6e22e">cacheStack</span>.<span style="color:#a6e22e">push</span>([<span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">result</span>])
      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">resource</span>) {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">key</span>)) {
          <span style="color:#a6e22e">result</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>(<span style="color:#a6e22e">resource</span>[<span style="color:#a6e22e">key</span>])
        }
      }
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
    }
  }
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resource</span>
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">findCache</span>(<span style="color:#a6e22e">resource</span>) {
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">cacheStack</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cacheStack</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">===</span> <span style="color:#a6e22e">resource</span>) {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cacheStack</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">1</span>]
    }
  }
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">deepClone</span>
</code></pre></div><p><a href="https://github.com/JinChengJoker/deep-clone">查看完整的代码</a></p>
</section>

  
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://jinchengjoker.github.io/posts/misc/currying/"><span>←</span><span>用 JS 理解函数柯里化</span></a>
     
    <a class="next" href="https://jinchengjoker.github.io/posts/misc/eventhub/"><span>用 TS 实现 EventHub（发布/订阅模式）</span><span>→</span></a>
    
  </nav>
  

  
  
</article>

</main>

    <footer class="footer">
  <p>&copy; 2022 <a href="https://jinchengjoker.github.io/">金成的博客</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

  </body>
</html>
