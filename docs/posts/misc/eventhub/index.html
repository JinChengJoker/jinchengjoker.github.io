<!DOCTYPE html>











<html lang="zh-Hans">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>用 TS 实现 EventHub（发布/订阅模式） - 金成的博客</title>

  
  
  <meta name="description" content="确定 API  EventHub#on EventHub#emit EventHub#off  测试环境搭建 TDD：测试驱动开发
安装 ts-node：
yarn global add ts-node初始化一个 EventHub 类：
// index.ts  class EventHub {} export default EventHub 编写测试用例：
// test/index.ts  import EventHub from &#39;../index&#39; // 测试 eventhub 是否正确生成 const testEventHub = (message) =&gt; { const eventhub = new EventHub() console.assert(eventhub instanceof Object === true, &#39;eventhub 应该是一个 object&#39;) console.log(message) } testEventHub(&#39;测试 eventhub 是否正确生成&#39;) 用 ts-node 运行测试：
ts-node test/index.ts初步实现 on 和 emit 添加测试用例：" />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://jinchengjoker.github.io/app.min.css" />

  
  <link rel="preload stylesheet" as="style" href="https://jinchengjoker.github.io/an-old-hope.min.css" />
  <script
    defer
    src="https://jinchengjoker.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  <link rel="preload" as="image" href="https://jinchengjoker.github.io/theme.png" />

  

  
  <link rel="icon" href="https://jinchengjoker.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://jinchengjoker.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.92.2" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="用 TS 实现 EventHub（发布/订阅模式）" />
<meta property="og:description" content="确定 API  EventHub#on EventHub#emit EventHub#off  测试环境搭建 TDD：测试驱动开发
安装 ts-node：
yarn global add ts-node初始化一个 EventHub 类：
// index.ts  class EventHub {} export default EventHub 编写测试用例：
// test/index.ts  import EventHub from &#39;../index&#39; // 测试 eventhub 是否正确生成 const testEventHub = (message) =&gt; { const eventhub = new EventHub() console.assert(eventhub instanceof Object === true, &#39;eventhub 应该是一个 object&#39;) console.log(message) } testEventHub(&#39;测试 eventhub 是否正确生成&#39;) 用 ts-node 运行测试：
ts-node test/index.ts初步实现 on 和 emit 添加测试用例：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jinchengjoker.github.io/posts/misc/eventhub/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-11T00:00:00+08:00" />
<meta property="article:modified_time" content="2019-09-11T00:00:00+08:00" />


  
  <meta itemprop="name" content="用 TS 实现 EventHub（发布/订阅模式）">
<meta itemprop="description" content="确定 API  EventHub#on EventHub#emit EventHub#off  测试环境搭建 TDD：测试驱动开发
安装 ts-node：
yarn global add ts-node初始化一个 EventHub 类：
// index.ts  class EventHub {} export default EventHub 编写测试用例：
// test/index.ts  import EventHub from &#39;../index&#39; // 测试 eventhub 是否正确生成 const testEventHub = (message) =&gt; { const eventhub = new EventHub() console.assert(eventhub instanceof Object === true, &#39;eventhub 应该是一个 object&#39;) console.log(message) } testEventHub(&#39;测试 eventhub 是否正确生成&#39;) 用 ts-node 运行测试：
ts-node test/index.ts初步实现 on 和 emit 添加测试用例："><meta itemprop="datePublished" content="2019-09-11T00:00:00+08:00" />
<meta itemprop="dateModified" content="2019-09-11T00:00:00+08:00" />
<meta itemprop="wordCount" content="467">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="用 TS 实现 EventHub（发布/订阅模式）"/>
<meta name="twitter:description" content="确定 API  EventHub#on EventHub#emit EventHub#off  测试环境搭建 TDD：测试驱动开发
安装 ts-node：
yarn global add ts-node初始化一个 EventHub 类：
// index.ts  class EventHub {} export default EventHub 编写测试用例：
// test/index.ts  import EventHub from &#39;../index&#39; // 测试 eventhub 是否正确生成 const testEventHub = (message) =&gt; { const eventhub = new EventHub() console.assert(eventhub instanceof Object === true, &#39;eventhub 应该是一个 object&#39;) console.log(message) } testEventHub(&#39;测试 eventhub 是否正确生成&#39;) 用 ts-node 运行测试：
ts-node test/index.ts初步实现 on 和 emit 添加测试用例："/>

  
  
</head>


  <body class="not-ready" data-menu="false">
    <header class="header">
  
  <p class="logo">
    <a class="site-name" href="https://jinchengjoker.github.io/">金成的博客</a><a class="btn-dark"></a>
  </p>
  

  <script>
    let bodyClx = document.body.classList;
    let btnDark = document.querySelector('.btn-dark');
    let sysDark = window.matchMedia('(prefers-color-scheme: dark)');
    let darkVal = localStorage.getItem('dark');

    let setDark = (isDark) => {
      bodyClx[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark ? 'yes' : 'no');
    };

    setDark(darkVal ? darkVal === 'yes' : sysDark.matches);
    requestAnimationFrame(() => bodyClx.remove('not-ready'));

    btnDark.addEventListener('click', () => setDark(!bodyClx.contains('dark')));
    sysDark.addEventListener('change', (event) => setDark(event.matches));
  </script>

  
  

  
</header>


    <main class="main">

<article class="post-single">
  <header class="post-title">
    <p>
      
      <time>Sep 11, 2019</time>
      
      
    </p>
    <h1>用 TS 实现 EventHub（发布/订阅模式）</h1>
  </header>
  <section class="post-content"><h2 id="确定-api">确定 API</h2>
<ul>
<li>EventHub#on</li>
<li>EventHub#emit</li>
<li>EventHub#off</li>
</ul>
<h2 id="测试环境搭建">测试环境搭建</h2>
<p><em>TDD：测试驱动开发</em></p>
<p>安装 ts-node：</p>
<pre tabindex="0"><code>yarn global add ts-node
</code></pre><p>初始化一个 EventHub 类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><p>编写测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// test/index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">EventHub</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../index&#39;</span>

<span style="color:#75715e">// 测试 eventhub 是否正确生成
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">testEventHub</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">message</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventhub</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHub</span>()
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">eventhub</span> <span style="color:#66d9ef">instanceof</span> Object <span style="color:#f92672">===</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#39;eventhub 应该是一个 object&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">message</span>)
}

<span style="color:#a6e22e">testEventHub</span>(<span style="color:#e6db74">&#39;测试 eventhub 是否正确生成&#39;</span>)
</code></pre></div><p>用 ts-node 运行测试：</p>
<pre tabindex="0"><code>ts-node test/index.ts
</code></pre><h2 id="初步实现-on-和-emit">初步实现 on 和 emit</h2>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// test/index.ts
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 测试 on 和 emit
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">testOnAndEmit</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">message</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventhub</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHub</span>()
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">called</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;test-on-emit&#39;</span>, () =&gt; {
    <span style="color:#a6e22e">called</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  })
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;test-on-emit&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">called</span>, <span style="color:#e6db74">&#39;called 应该为 true&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">message</span>)
}

<span style="color:#a6e22e">testOnAndEmit</span>(<span style="color:#e6db74">&#39;测试 on 和 emit&#39;</span>)
</code></pre></div><p>代码实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {
  <span style="color:#a6e22e">callstack</span> <span style="color:#f92672">=</span> {}
  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">fn</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">=</span> []
    }
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>)
  }
  <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">fn</span>) =&gt; {
      <span style="color:#a6e22e">fn</span>()
    })
  }
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><h2 id="优化代码">优化代码</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {
  <span style="color:#a6e22e">callstack</span> <span style="color:#f92672">=</span> {}
  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">fn</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">||</span> []
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>)
  }
  <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">fn</span> =&gt; <span style="color:#a6e22e">fn</span>())
  }
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><h2 id="支持数据传递">支持数据传递</h2>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// test/index.ts
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 测试数据传递
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">testDataTransmission</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">message</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventhub</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHub</span>()
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">testdata</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;test-data&#39;</span>, (<span style="color:#a6e22e">data</span>) =&gt; {
    <span style="color:#a6e22e">testdata</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>
  })
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;test-data&#39;</span>, <span style="color:#ae81ff">100</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">testdata</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">100</span>, <span style="color:#e6db74">&#39;testdata 应该等于 100&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">message</span>)
}

<span style="color:#a6e22e">testDataTransmission</span>(<span style="color:#e6db74">&#39;测试数据传递&#39;</span>)
</code></pre></div><p>修改 EventHub，给 emit 添加第二个参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {
  <span style="color:#a6e22e">callstack</span> <span style="color:#f92672">=</span> {}
  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">fn</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">||</span> []
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>)
  }
  <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">data</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">fn</span> =&gt; <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">data</span>))
  }
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><h3 id="typescript-的可选参数">TypeScript 的可选参数</h3>
<p>因为给 EventHub 的 emit 添加了第二个参数，但是有时候不需要传递数据，用不到这个参数，在 TypeScript 中，调用时会报错，提示需要传入两个参数。</p>
<p>可以给参数添加后缀 ? 来表示这是一个可选参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">data</span><span style="color:#f92672">?</span>) {
  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">fn</span> =&gt; <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">data</span>))
}
</code></pre></div><h2 id="实现取消订阅-off">实现取消订阅 off</h2>
<p>添加测试用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// test/index.ts
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 测试 off
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">testOff</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">message</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventhub</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventHub</span>()
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">called</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fn1</span> <span style="color:#f92672">=</span> () =&gt; {
    <span style="color:#a6e22e">called</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
  }
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;test-off&#39;</span>, <span style="color:#a6e22e">fn1</span>)
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">off</span>(<span style="color:#e6db74">&#39;test-off&#39;</span>, <span style="color:#a6e22e">fn1</span>)
  <span style="color:#a6e22e">eventhub</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;test-off&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">called</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#39;called 应该为 false&#39;</span>)
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">message</span>)
}

<span style="color:#a6e22e">testOff</span>(<span style="color:#e6db74">&#39;测试 off&#39;</span>)
</code></pre></div><p>给 EventHub 添加 off 方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {
  <span style="color:#a6e22e">callstack</span> <span style="color:#f92672">=</span> {}
  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">fn</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">||</span> []
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>)
  }
  <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">data</span><span style="color:#f92672">?</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">fn</span> =&gt; <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">data</span>))
  }
  <span style="color:#a6e22e">off</span>(<span style="color:#a6e22e">eventname</span>, <span style="color:#a6e22e">fn</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">fn</span>)
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">===</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>)
  }
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><h2 id="使用-typescript-完善代码">使用 TypeScript 完善代码</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// index.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHub</span> {
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">callstack</span><span style="color:#f92672">:</span> {[<span style="color:#a6e22e">key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>]<span style="color:#f92672">:</span> Array<span style="color:#f92672">&lt;</span>(<span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>) =&gt; <span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span>} <span style="color:#f92672">=</span> {}
  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventname</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>) =&gt; <span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">||</span> []
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>)
  }
  <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">eventname</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">data</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">any</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">fn</span> =&gt; <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">data</span>))
  }
  <span style="color:#a6e22e">off</span>(<span style="color:#a6e22e">eventname</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>) =&gt; <span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">fn</span>)
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">===</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callstack</span>[<span style="color:#a6e22e">eventname</span>].<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>)
  }
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">EventHub</span>
</code></pre></div><p><a href="https://github.com/JinChengJoker/EventHub">查看完整的代码</a></p>
</section>

  
  

  
  
  
  <nav class="post-nav">
    
    <a class="prev" href="https://jinchengjoker.github.io/posts/js/deep_clone/"><span>←</span><span>JS 实现深拷贝</span></a>
     
    <a class="next" href="https://jinchengjoker.github.io/posts/js/higher_function/"><span>JS 高阶函数</span><span>→</span></a>
    
  </nav>
  

  
  
</article>

</main>

    <footer class="footer">
  <p>&copy; 2022 <a href="https://jinchengjoker.github.io/">金成的博客</a></p>
  <p>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</p>
  <p>
    <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper 5.1</a>
  </p>
</footer>

  </body>
</html>
